<html>
    <head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2JHM7SP9CG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2JHM7SP9CG');
</script>
<meta name="viewport"
content="width=device-width,
initial-scale=1.0">
<title>Check unapproved PYQs</title></head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <body style="background-color: rgb(141, 197, 219);">
<center>
    <h1>Pending approval PYQs</h1>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <div id="reviewList"></div>

    <script>
        const Supabase = supabase.createClient(
    "https://irpdlkhewvvqjperruxt.supabase.co",   // Replace with your Project URL
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycGRsa2hld3Z2cWpwZXJydXh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNTE1NTgsImV4cCI6MjA4MTcyNzU1OH0.9qiUMOAFP_a2V6eKYpTsiG9jbmnW4d5-NDmP-nlni7E"       // Replace with your anon/public key
  );

async function loadUnderReview() {
  const { data, error } = await Supabase
    .from("bubcapyqs")
    .select("*")
    .eq("status",'under_review');

  if (error) {
    console.error(error);
    return;
  }


  renderPapers(data)
}

loadUnderReview();



function renderPapers(papers) {
  const container = document.getElementById("reviewList");
  container.innerHTML = "";
  if(papers.length>0)
  {
    papers.forEach(p => {

      const{data}=Supabase.storage
      .from("bubcapyqs")
      .getPublicUrl(p.file_url);

    const div = document.createElement("div");
    div.className="paper-meta";
    div.innerHTML = `
      <p>Semester: ${p.semester}</p>
      <a href="${data.publicUrl}" target="_blank">View Paper</a>
      <div id='correct_block'>Is this paper correct?
      <button  onclick="vote('${p.id}', ${p.votes})">
        Yes,this paper is correct.
      </button>
      <button onclick="downvote('${p.id}', ${p.votes})">
        No,this paper is wrong.
      </button>
      </div>
      <div class="divider"></div>
    `;
    container.appendChild(div);
  });
  }
  else{
    const div = document.getElementById("reviewList");
    div.textContent="Nothing here yet!";
  }
}



async function vote(id, currentVotes) {
    const block=document.getElementById("correct_block");
    block.remove();
  const newVotes = currentVotes + 1;

  let updateData = { votes: newVotes };

  if (newVotes >= 5) {
    updateData.status = "approved";
  }

  const { error } = await Supabase
    .from("bubcapyqs")
    .update(updateData)
    .eq("id", id);

   // alert("Thank you for your contribution. It will help many students.")

    
Toastify({
  text: "Thank you for contributing ❤️! It will help many students!",
  duration: 4000,
  gravity: "bottom",
  position: "center",
}).showToast();



}

async function downvote(id, currentVotes) {
    const block=document.getElementById("correct_block");
    block.remove();
  const newVotes = currentVotes - 1;

  let updateData = { votes: newVotes };

  if (newVotes <0) {
  const {data, error } = await Supabase
    .from("bubcapyqs")
    .delete()
    .eq("id", id);

  }
  else{

  const { error } = await Supabase
    .from("bubcapyqs")
    .update(updateData)
    .eq("id", id);
  }
//alert("Thank you for contributing . It will help many students.")
Toastify({
  text: "Thank you for contributing ❤️! It will help many students!",
  duration: 4000,
  gravity: "bottom",
  position: "center",
}).showToast();

  } 

</script>

</center>
    </body>
</html>