<html>
    <head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2JHM7SP9CG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2JHM7SP9CG');
</script>
<meta name="viewport"
content="width=device-width,
initial-scale=1.0">
<title>Upload PYQs</title></head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <body>
        <center>
        <h1>Upload BU BCA PYQs</h1>

        <table  border=0 style="width:20%;height:55%">
           <tr><td align="center">
        <select  id="semester">
            <option value="">Select Semester</option>
            <option value="1">Semester 1</option>
            <option value="2">Semester 2</option>
            <option value="3">Semester 3</option>
            <option value="4">Semester 4</option>
            <option value="5">Semester 5</option>
            <option value="6">Semester 6</option>
            <option value="7" disabled>Semester 7</option>
            <option value="8" disabled>Semester 8</option>
        </select>
        </td></tr>
        <tr>
            <td>
                <input type="file"  id="file" accept="application/pdf">
            </td></tr>
            <tr><td>

                <center><button onclick="uploadPYQ()">Upload</button></center>

            </td>
        </tr>
        </table>

<div id="uploadOverlay" class="overlay hidden">
  <div class="modal">
    <p id="uploadText">Uploading… please wait</p>
  </div>
</div>

        </center>
    </body>
</html>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script src="upload.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    async function uploadPYQ()
    {
        const semester=document.getElementById("semester").value;
        const file = document.getElementById("file").files[0];
        if(!semester || !file)
    {
        alert("Fill all fields");
        return;
    }


      // size check
    if (file.size > 10 * 1024 * 1024) {
      alert("Max file size is 10MB");
      return;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
      const bytes = new Uint8Array(e.target.result);
      const header = String.fromCharCode(...bytes.slice(0, 5));
      if (header !== "%PDF-") {
        alert("Invalid PDF file");
        return;
      }
      uploadStart(file);

    };

    reader.readAsArrayBuffer(file.slice(0, 5));

    async function uploadStart(file)
    {
    //Needs the code of uploading here
      showUploadModal();
    const file_name=`${file.name.substring(0,file.name.lastIndexOf("."))}_Sem${semester}${Math.random().toString(36).substring(2,10)}.pdf`;
    const filePath = `sem${semester}/${file_name}`;

    const { error: uploadError } = await Supabase
    .storage
    .from("bubcapyqs")
    .upload(filePath, file);
  if (uploadError) {
    alert("Upload failed");
    console.error(uploadError);
    return;
  }
  saveMetadata(semester, file_name, filePath);
    }
  }
   async function saveMetadata(semester, file_name, filePath) {
  const { data, error } = await Supabase
    .from("bubcapyqs")
    .insert([
      {
        semester: semester,
        file_name:file_name,
        file_url: filePath,
      }
    ]);

  if (error) {
    alert("DB insert failed");
    console.error(error);
    return;
  }
else{
      document.getElementById("uploadText").innerText = "Uploaded successfully ✅";

    setTimeout(() => {
      hideUploadModal();
    }, 1500);

    Toastify({
    text: "Thank you for contributing ❤️! It will help many students!",
    duration: 4000,
    gravity: "bottom",
    position: "center",
    }).showToast();

        return;
    }
  
}

function showUploadModal(text = "Uploading… please wait") {
  document.getElementById("uploadText").innerText = text;
  document.getElementById("uploadOverlay").classList.remove("hidden");
}

function hideUploadModal() {
  document.getElementById("uploadOverlay").classList.add("hidden");
}

 
</script>